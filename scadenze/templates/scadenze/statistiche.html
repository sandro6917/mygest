{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Statistiche Scadenze" %}{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
.stats-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 30px;
  border-radius: 12px;
  margin-bottom: 25px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.stats-header h1 {
  margin: 0 0 10px 0;
  font-size: 32px;
  font-weight: 700;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  text-align: center;
}

.stat-value {
  font-size: 36px;
  font-weight: 700;
  color: #667eea;
  margin: 10px 0;
}

.stat-label {
  font-size: 14px;
  color: #6b7280;
  text-transform: uppercase;
  font-weight: 600;
}

.chart-container {
  background: white;
  padding: 25px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-bottom: 25px;
}

.chart-title {
  font-size: 18px;
  font-weight: 700;
  color: #374151;
  margin-bottom: 20px;
}

.top-list {
  background: white;
  padding: 25px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.top-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid #f3f4f6;
}

.top-item:last-child {
  border-bottom: none;
}

.top-rank {
  font-size: 24px;
  font-weight: 700;
  color: #667eea;
  width: 40px;
}

.top-title {
  flex: 1;
  font-weight: 600;
  color: #374151;
}

.top-count {
  background: #667eea;
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="stats-header">
    <h1>ðŸ“Š {% trans "Statistiche Scadenze" %}</h1>
    <p style="margin:0; opacity:0.95;">{% trans "Analisi e andamento delle scadenze" %}</p>
    <div style="margin-top:15px;">
      <a class="btn btn-light btn-sm" href="{% url 'scadenze:home' %}" style="margin-right:8px;">{% trans "Torna alle scadenze" %}</a>
      <a class="btn btn-light btn-sm" href="{% url 'scadenze:scadenziario' %}" style="margin-right:8px;">{% trans "Scadenziario" %}</a>
      <a class="btn btn-light btn-sm" href="{% url 'scadenze:calendario_visual' %}">{% trans "Calendario" %}</a>
    </div>
  </div>

  <!-- Statistiche generali -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">{% trans "Totale Scadenze" %}</div>
      <div class="stat-value">{{ totale_scadenze }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">{% trans "Occorrenze (6 mesi)" %}</div>
      <div class="stat-value">{{ totale_occorrenze }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">{% trans "Completate" %}</div>
      <div class="stat-value" style="color:#10b981;">{{ occorrenze_completate }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">{% trans "Pendenti" %}</div>
      <div class="stat-value" style="color:#f59e0b;">{{ occorrenze_pendenti }}</div>
    </div>
  </div>

  <!-- Grafici -->
  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:25px; margin-bottom:25px;">
    <!-- Distribuzione per prioritÃ  -->
    <div class="chart-container">
      <div class="chart-title">{% trans "Distribuzione per PrioritÃ " %}</div>
      <canvas id="prioritaChart"></canvas>
    </div>

    <!-- Distribuzione per stato -->
    <div class="chart-container">
      <div class="chart-title">{% trans "Distribuzione per Stato" %}</div>
      <canvas id="statoChart"></canvas>
    </div>
  </div>

  <!-- Andamento mensile -->
  <div class="chart-container">
    <div class="chart-title">{% trans "Andamento Mensile (6 mesi)" %}</div>
    <canvas id="andamentoChart" style="max-height:300px;"></canvas>
  </div>

  <!-- Alert statistiche -->
  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:25px;">
    <div class="stat-card">
      <div class="stat-label">{% trans "Totale Alert" %}</div>
      <div class="stat-value">{{ totale_alert }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">{% trans "Alert Inviati" %}</div>
      <div class="stat-value" style="color:#10b981;">{{ alert_inviati }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">{% trans "Alert Pendenti" %}</div>
      <div class="stat-value" style="color:#f59e0b;">{{ alert_pendenti }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">{% trans "Alert Falliti" %}</div>
      <div class="stat-value" style="color:#dc2626;">{{ alert_falliti }}</div>
    </div>
  </div>

  <!-- Top 5 scadenze -->
  <div class="top-list">
    <div class="chart-title">{% trans "Top 5 Scadenze (per occorrenze)" %}</div>
    {% if scadenze_top %}
      {% for scadenza in scadenze_top %}
        <div class="top-item">
          <div class="top-rank">#{{ forloop.counter }}</div>
          <div class="top-title">
            <a href="{% url 'scadenze:detail' scadenza.id %}" style="text-decoration:none; color:inherit;">
              {{ scadenza.titolo }}
            </a>
          </div>
          <div class="top-count">{{ scadenza.num_occorrenze }}</div>
        </div>
      {% endfor %}
    {% else %}
      <p style="color:#9ca3af; text-align:center; margin:20px 0;">{% trans "Nessuna scadenza" %}</p>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dati dal context Django
const prioritaStats = {{ priorita_stats|safe }};
const statoStats = {{ stato_stats|safe }};
const andamentoMensile = {{ andamento_mensile|safe }};

// Grafico prioritÃ  (Doughnut)
const prioritaCtx = document.getElementById('prioritaChart').getContext('2d');
new Chart(prioritaCtx, {
  type: 'doughnut',
  data: {
    labels: Object.keys(prioritaStats),
    datasets: [{
      data: Object.values(prioritaStats),
      backgroundColor: [
        '#dc2626',  // Critica
        '#f59e0b',  // Alta
        '#3b82f6',  // Media
        '#6b7280'   // Bassa
      ],
      borderWidth: 2,
      borderColor: '#fff'
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: {
        position: 'bottom',
        labels: {
          padding: 15,
          font: {
            size: 12
          }
        }
      }
    }
  }
});

// Grafico stati (Pie)
const statoCtx = document.getElementById('statoChart').getContext('2d');
new Chart(statoCtx, {
  type: 'pie',
  data: {
    labels: Object.keys(statoStats),
    datasets: [{
      data: Object.values(statoStats),
      backgroundColor: [
        '#10b981',  // Completato
        '#3b82f6',  // Notificato
        '#6b7280',  // Annullato
        '#f3f4f6'   // Pendente
      ],
      borderWidth: 2,
      borderColor: '#fff'
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: {
        position: 'bottom',
        labels: {
          padding: 15,
          font: {
            size: 12
          }
        }
      }
    }
  }
});

// Grafico andamento mensile (Bar + Line)
const andamentoCtx = document.getElementById('andamentoChart').getContext('2d');
new Chart(andamentoCtx, {
  type: 'bar',
  data: {
    labels: andamentoMensile.map(m => m.label),
    datasets: [
      {
        label: 'Totale Occorrenze',
        data: andamentoMensile.map(m => m.totale),
        backgroundColor: 'rgba(102, 126, 234, 0.7)',
        borderColor: '#667eea',
        borderWidth: 2
      },
      {
        label: 'Completate',
        data: andamentoMensile.map(m => m.completate),
        type: 'line',
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.2)',
        borderWidth: 3,
        fill: true,
        tension: 0.4
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    interaction: {
      mode: 'index',
      intersect: false
    },
    plugins: {
      legend: {
        position: 'top',
        labels: {
          padding: 15,
          font: {
            size: 13
          }
        }
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          precision: 0
        }
      }
    }
  }
});
</script>
{% endblock %}
