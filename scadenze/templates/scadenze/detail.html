{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ scadenza.titolo }}{% endblock %}

{% block content %}
<div class="container">
  <div class="page-header">
    <h1>{{ scadenza.titolo }}</h1>
    <div class="actions">
      <a class="btn btn-secondary" href="{% url 'scadenze:update' scadenza.pk %}">{% trans "Modifica" %}</a>
      <a class="btn" href="{% url 'scadenze:bulk_generate' scadenza.pk %}">{% trans "Generazione massiva" %}</a>
    </div>
  </div>

  <div class="grid" style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
    <section class="card">
      <h2>{% trans "Informazioni" %}</h2>
      <div class="body">
        <dl class="kv">
          <dt>{% trans "Stato" %}</dt><dd>{{ scadenza.get_stato_display }}</dd>
          <dt>{% trans "Priorit√†" %}</dt><dd>{{ scadenza.get_priorita_display }}</dd>
          <dt>{% trans "Categoria" %}</dt><dd>{{ scadenza.categoria|default:"‚Äî" }}</dd>
          <dt>{% trans "Periodicit√°" %}</dt><dd>{{ scadenza.get_periodicita_display }}</dd>
          <dt>{% trans "Assegnatari" %}</dt>
          <dd>
            {% if scadenza.assegnatari.all %}
              {% for user in scadenza.assegnatari.all %}
                <span class="tag">{{ user.get_full_name|default:user.username }}</span>
              {% empty %}
                ‚Äî
              {% endfor %}
            {% else %}
              ‚Äî
            {% endif %}
          </dd>
          <dt>{% trans "Descrizione" %}</dt><dd>{{ scadenza.descrizione|linebreaksbr|default:"‚Äî" }}</dd>
          <dt>{% trans "Note interne" %}</dt><dd>{{ scadenza.note_interne|linebreaksbr|default:"‚Äî" }}</dd>
        </dl>
      </div>
    </section>

    <section class="card">
      <h2>{% trans "Collegamenti" %}</h2>
      <div class="body">
        <div class="muted">{% trans "Pratiche" %}</div>
        {% with pratiche=scadenza.pratiche.all %}
          {% if pratiche %}
            <ul class="list">
              {% for pr in pratiche %}
                <li><a class="link" href="{% url 'pratiche:dettaglio' pr.pk %}">{{ pr.codice }}</a></li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="muted">‚Äî</div>
          {% endif %}
        {% endwith %}
        <div class="muted" style="margin-top:8px;">{% trans "Fascicoli" %}</div>
        {% with fascicoli=scadenza.fascicoli.all %}
          {% if fascicoli %}
            <ul class="list">
              {% for fa in fascicoli %}
                <li><a class="link" href="{% url 'fascicoli:detail' fa.pk %}">{{ fa.codice|default:fa.titolo }}</a></li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="muted">‚Äî</div>
          {% endif %}
        {% endwith %}
        <div class="muted" style="margin-top:8px;">{% trans "Documenti" %}</div>
        {% with documenti=scadenza.documenti.all %}
          {% if documenti %}
            <ul class="list">
              {% for doc in documenti %}
                <li><a class="link" href="{% url 'documenti:dettaglio' doc.pk %}">{{ doc.descrizione|default:doc }}</a></li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="muted">‚Äî</div>
          {% endif %}
        {% endwith %}
      </div>
    </section>
  </div>

  <section class="card">
    <h2>{% trans "Occorrenze" %}</h2>
    <div class="body">
      {% if occorrenze %}
        <table class="table">
          <thead>
            <tr>
              <th>{% trans "Titolo" %}</th>
              <th>{% trans "Data/Ora" %}</th>
              <th>{% trans "Alert Configurati" %}</th>
              <th>{% trans "Stato" %}</th>
              <th>{% trans "Azioni" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for occ in occorrenze %}
              <tr>
                <td>
                  <div style="font-weight:600;">{{ occ.titolo|default:scadenza.titolo }}</div>
                  {% if occ.descrizione %}
                    <div class="muted" style="font-size:12px; margin-top:4px;">{{ occ.descrizione|truncatewords:15 }}</div>
                  {% endif %}
                </td>
                <td>
                  <div style="font-weight:600;">{{ occ.inizio|date:"d/m/Y H:i" }}</div>
                  {% if occ.fine %}
                    <div class="muted" style="font-size:12px;">‚Üí {{ occ.fine|date:"d/m/Y H:i" }}</div>
                  {% endif %}
                  {% if occ.giornaliera %}
                    <span class="badge" style="background:#e5e7eb; color:#374151; margin-top:4px;">üóìÔ∏è {% trans "Giornaliero" %}</span>
                  {% endif %}
                </td>
                <td>
                  {% with alerts=occ.alerts.all %}
                    {% if alerts %}
                      <div style="font-size:13px;">
                        {% for alert in alerts %}
                          <div style="margin-bottom:4px;">
                            {% if alert.stato == 'sent' %}
                              <span style="color:#10b981;">‚úì</span>
                            {% elif alert.stato == 'failed' %}
                              <span style="color:#ef4444;">‚úó</span>
                            {% else %}
                              <span style="color:#f59e0b;">‚è∞</span>
                            {% endif %}
                            <strong>{{ alert.offset_alert }}</strong> {{ alert.get_offset_alert_periodo_display }}
                            {% trans "prima" %} 
                            <span class="badge" style="background:#f3f4f6; color:#374151; font-size:10px;">
                              {{ alert.get_metodo_alert_display }}
                            </span>
                            {% if alert.alert_programmata_il %}
                              <div class="muted" style="font-size:11px; margin-left:20px;">
                                {{ alert.alert_programmata_il|date:"d/m/Y H:i" }}
                              </div>
                            {% endif %}
                          </div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <span class="muted">{% trans "Nessun alert" %}</span>
                    {% endif %}
                  {% endwith %}
                </td>
                <td>
                  <span class="badge" style="
                    {% if occ.stato == 'completed' %}background:#10b981; color:white;
                    {% elif occ.stato == 'alerted' %}background:#3b82f6; color:white;
                    {% else %}background:#f3f4f6; color:#374151;
                    {% endif %}
                  ">{{ occ.get_stato_display }}</span>
                </td>
                <td>
                  <form method="post" action="{% url 'scadenze:trigger_alert' occ.pk %}" style="display:inline">
                    {% csrf_token %}
                    <button class="btn btn-secondary btn-sm" type="submit">{% trans "Invia alert" %}</button>
                  </form>
                </td>
              </tr>
              {% if occ.log_eventi.all %}
                <tr>
                  <td colspan="5" style="background:#f9fafb; padding:10px 15px;">
                    <div class="muted" style="font-size:12px;">
                      <strong>{% trans "Log" %}:</strong>
                      {% for log in occ.log_eventi.all %}
                        <span class="badge" style="background:{% if log.esito %}#10b981{% else %}#ef4444{% endif %}; color:white; margin:2px;">
                          {{ log.get_evento_display }} ({{ log.registrato_il|date:"d/m/Y H:i" }})
                        </span>
                      {% endfor %}
                    </div>
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="muted">{% trans "Nessuna occorrenza" %}</div>
      {% endif %}
    </div>
  </section>
</div>

<style>
.badge {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table th {
  background: #f9fafb;
  padding: 12px 15px;
  text-align: left;
  font-weight: 600;
  font-size: 12px;
  text-transform: uppercase;
  color: #6b7280;
  border-bottom: 2px solid #e5e7eb;
}

.table td {
  padding: 12px 15px;
  border-bottom: 1px solid #f3f4f6;
  vertical-align: top;
}

.table tbody tr:hover {
  background: #fafafa;
}
</style>
{% endblock %}
