{% extends "base.html" %}
{% block title %}{% if form %}Nuovo documento — {{ tipo }}{% else %}Nuovo documento — scegli tipo{% endif %}{% endblock %}
{% block extra_head %}{% if form %}{{ form.media }}{% endif %}{% endblock %}
{% block content %}
<div class="container">
  <section class="card card-full">
    <h2>{% if form %}Nuovo documento — {{ tipo }}{% else %}Scegli il tipo di documento{% endif %}</h2>
    <div class="body">

      {% if not form %}
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="step" value="select_type">
          <!-- preserva i parametri di contesto (fascicolo/pratica/cliente) -->
          {% if preserved %}
            {% for k,v in preserved.items %}
              <input type="hidden" name="{{ k }}" value="{{ v }}">
            {% endfor %}
          {% endif %}

          <div class="form-row" style="margin-bottom:12px">
            <label for="tipo_id"><strong>Tipo</strong></label>
            <select id="tipo_id" name="tipo_id" required>
              <option value="">— scegli —</option>
              {% for t in tipi %}
                <option value="{{ t.id }}">{{ t }}</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Continua</button>
        </form>
      {% else %}
        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          {{ form.non_field_errors }}
          <!-- preserva parametri se servono al salvataggio -->
          {% if preserved %}
            {% for k,v in preserved.items %}
              <input type="hidden" name="{{ k }}" value="{{ v }}">
            {% endfor %}
          {% endif %}
          {% for hf in form.hidden_fields %}{{ hf }}{% endfor %}

          <!-- passa sempre il tipo selezionato allo step di salvataggio -->
          <input type="hidden" name="tipo_id" value="{{ tipo.id }}">

          {% for field in form %}
            {% if field.name != 'file_operation' %}
          <div style="margin:6px 0">
            <label for="{{ field.id_for_label }}">{{ field.label }}</label><br>
            {{ field }}
            {% if field.help_text %}<div class="muted">{{ field.help_text }}</div>{% endif %}
            {% for err in field.errors %}<div style="color:#c62828">{{ err }}</div>{% endfor %}
            
            <!-- Mostra il campo file_operation subito dopo il campo file -->
            {% if field.name == 'file' %}
              {% for f in form %}
                {% if f.name == 'file_operation' %}
            <div style="margin:12px 0; padding:10px; background:#f5f5f5; border-radius:4px">
              <label for="{{ f.id_for_label }}"><strong>{{ f.label }}</strong></label><br>
              {{ f }}
              {% if f.help_text %}<div class="muted" style="margin-top:6px">{{ f.help_text }}</div>{% endif %}
              {% for err in f.errors %}<div style="color:#c62828">{{ err }}</div>{% endfor %}
            </div>
                {% endif %}
              {% endfor %}
            {% endif %}
          </div>
            {% endif %}
          {% endfor %}

          <div style="margin-top:12px; display:flex; gap:8px">
            <button type="submit" class="btn btn-primary">Salva</button>
            <a class="btn btn-secondary" href="javascript:history.back()">Annulla</a>
          </div>
        </form>
      {% endif %}

    </div>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  console.log("Inizializzazione Select2 avviata");
  
  // Debug: mostra tutti i campi con classe select2
  var select2Fields = $('.select2');
  console.log("Campi con classe select2 trovati:", select2Fields.length);
  
  // Inizializza Select2 su tutti i campi con classe select2
  select2Fields.each(function(index) {
    var $element = $(this);
    console.log("Inizializzazione campo", index, ":", $element.attr('name'), $element.attr('id'));
    
    var placeholder = $element.data('placeholder') || 'Seleziona...';
    var allowClear = $element.data('allow-clear') !== undefined ? $element.data('allow-clear') : true;
    
    try {
      $element.select2({
        width: $element.data('width') || $element.css('width') || '100%',
        placeholder: placeholder,
        allowClear: allowClear,
        language: {
          noResults: function() {
            return "Nessun risultato trovato";
          },
          searching: function() {
            return "Ricerca in corso...";
          }
        }
      });
      console.log("Select2 inizializzato con successo per", $element.attr('name'));
    } catch(e) {
      console.error("Errore inizializzazione Select2:", e);
    }
  });
  
  console.log("Inizializzazione Select2 completata");
});
</script>
{% endblock %}