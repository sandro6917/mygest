{% extends "base.html" %}
{% load i18n %}
{% block title %}{% if is_create %}Nuova scadenza{% else %}Modifica scadenza{% endif %}{% endblock %}
{% block content %}
<div class="container">
  <div class="dashboard-grid">
    <section class="card card-full">
      <h2>{% if is_create %}Nuova scadenza{% else %}Modifica scadenza{% endif %}</h2>
      <div class="body">
        {% if pratica %}
          <div class="muted" style="margin-bottom:8px">
            Pratica: <strong>{{ pratica.codice }}</strong> â€” {{ pratica.oggetto }}
          </div>
        {% endif %}

        {% if form.errors %}
          <div class="alert alert-danger" style="margin-bottom:12px">
            <strong>{% trans "Correggi gli errori evidenziati." %}</strong>
          </div>
        {% endif %}

        <form method="post" novalidate>
          {% csrf_token %}

          {% if pratica %}{{ form.pratica.as_hidden }}{% endif %}

          <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <label><strong>{{ form.titolo.label }}</strong></label>
              {{ form.titolo }}{% for e in form.titolo.errors %}<div class="text-danger">{{ e }}</div>{% endfor %}
            </div>
            <div>
              <label><strong>{{ form.scadenza_at.label }}</strong></label>
              <div style="display:flex;align-items:center;gap:8px">
                {{ form.scadenza_at }}
                {% if pratica %}
                  <button type="button" id="calcola-btn" class="btn btn-outline-secondary btn-sm" title="Calcola data scadenza dalla data della pratica">
                    Calcola
                  </button>
                {% endif %}
              </div>
              {% for e in form.scadenza_at.errors %}<div class="text-danger">{{ e }}</div>{% endfor %}
            </div>
            <div style="grid-column:1 / -1">
              <label><strong>{{ form.descrizione.label }}</strong></label>
              {{ form.descrizione }}{% for e in form.descrizione.errors %}<div class="text-danger">{{ e }}</div>{% endfor %}
            </div>
            <div>
              <label><strong>{{ form.completata.label }}</strong></label>
              {{ form.completata }}{% for e in form.completata.errors %}<div class="text-danger">{{ e }}</div>{% endfor %}
            </div>
          </div>

          <!-- Popup per inserire i giorni -->
          <div id="popup" style="display:none; position:fixed; left:50%; top:30%; background:#fff; border:1px solid #ccc; padding:20px; z-index:1000;">
            <label>Giorni da aggiungere alla data della pratica:</label>
            <input type="number" id="giorni-input" value="30" min="1" class="form-control" style="width:80px;display:inline-block" />
            <button type="button" id="conferma-btn" class="btn btn-success btn-sm">Calcola</button>
            <button type="button" onclick="document.getElementById('popup').style.display='none'" class="btn btn-secondary btn-sm">Annulla</button>
          </div>

          <hr style="margin:16px 0">

          <h3>Alert</h3>
          {{ formset.management_form }}
          <div class="grid" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px">
            {% for f in formset.forms %}
              <div class="card" style="grid-column:1 / -1; padding:8px">
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 2fr 2fr auto;gap:8px;align-items:end">
                  <div>
                    <label><strong>{{ f.unita.label }}</strong></label>
                    {{ f.unita }}
                  </div>
                  <div>
                    <label><strong>{{ f.valore.label }}</strong></label>
                    {{ f.valore }}
                  </div>
                  <div>
                    <label><strong>{{ f.metodo.label }}</strong></label>
                    {{ f.metodo }}
                  </div>
                  <div>
                    <label><strong>{{ f.email_to.label }}</strong></label>
                    {{ f.email_to }}
                  </div>
                  <div>
                    <label><strong>{{ f.webhook_url.label }}</strong></label>
                    {{ f.webhook_url }}
                  </div>
                  <div>
                    <label><strong>{{ f.attivo.label }}</strong></label>
                    {{ f.attivo }}
                  </div>
                  {% if f.instance.pk %}<div style="grid-column:1 / -1">{{ f.DELETE }} <label>Elimina</label></div>{% endif %}
                  {% for e in f.non_field_errors %}<div class="text-danger" style="grid-column:1 / -1">{{ e }}</div>{% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>

          <div style="margin-top:12px; display:flex; gap:8px">
            <button type="submit" class="btn btn-primary">{% trans "Salva" %}</button>
            <a class="btn btn-secondary" href="{% url 'pratiche:dettaglio' pratica.pk %}">{% trans "Annulla" %}</a>
          </div>
        </form>
      </div>
    </section>
  </div>
</div>

{% if pratica %}
<script>
document.getElementById("calcola-btn").onclick = function() {
    document.getElementById("popup").style.display = "block";
};

document.getElementById("conferma-btn").onclick = function() {
    var giorni = document.getElementById("giorni-input").value;
    var url = "{% if not is_create %}{% url 'pratiche:calcola_scadenza' obj.pk %}{% else %}{% url 'pratiche:calcola_scadenza' 0 %}{% endif %}";
    var body = "giorni=" + encodeURIComponent(giorni);
    {% if is_create %}
    body = body + "&pratica={{ pratica.pk }}";
    {% endif %}
    fetch(url, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: body
    })
    .then(response => response.json())
    .then(data => {
        if (data.nuova_data) {
            let input = document.getElementById("id_scadenza_at");
            if (input) {
                input.value = data.nuova_data + "T00:00";
            }
        } else {
            alert("Errore: " + (data.error || "Impossibile calcolare"));
        }
        document.getElementById("popup").style.display = "none";
    });
};
</script>
{% endif %}
{% endblock %}